<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Translator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }

    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .recording-pulse::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 0.5rem;
      background: #ef4444;
      animation: pulse-ring 1.5s ease-out infinite;
    }
    .listening-indicator {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="h-full">
  <div id="app" class="w-full h-full"></div>

  <script>
    // ===== Default Config =====
    const defaultConfig = {
      background_color: "#f0f4f8",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#64748b",
      font_family: "system-ui",
      font_size: 16,
      app_title: "Voice Translator",
      subtitle: "Speak or type to translate",
      input_label: "From",
      output_label: "To",
      speak_button_text: "ðŸŽ¤ Speak",
      translate_button_text: "Translate",
      listen_button_text: "ðŸ”Š Listen"
    };

    let config = {...defaultConfig};
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let isListening = false;

    const languages = [
      { code: 'ms-MY', name: 'Malay', flag: 'ðŸ‡²ðŸ‡¾' },
      { code: 'en-US', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
      { code: 'zh-CN', name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
      { code: 'ta-IN', name: 'Tamil', flag: 'ðŸ‡®ðŸ‡³' }
    ];

    // ===== Create UI =====
    function createUI() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full overflow-auto p-6">
          <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
              <h1 id="title" class="font-bold mb-2"></h1>
              <p id="subtitle" class="opacity-80"></p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <!-- Input Section -->
              <div class="translation-card rounded-xl shadow-lg p-6">
                <label id="input-label" class="block font-semibold mb-4"></label>
                
                <div class="flex flex-wrap gap-2 mb-4">
                  ${languages.map(lang => `
                    <button class="lang-btn input-lang px-4 py-2 rounded-lg transition-all hover:scale-105" 
                            data-lang="${lang.code}">
                      <span class="mr-1">${lang.flag}</span>
                      <span class="lang-label">${lang.name}</span>
                    </button>
                  `).join('')}
                </div>

                <textarea id="input-text" 
                          class="w-full h-40 p-4 rounded-lg border-2 resize-none focus:outline-none focus:ring-2 transition-all"
                          placeholder="Type or speak your text here..."></textarea>

                <div class="flex gap-2 mt-4">
                  <button id="speak-btn" 
                          class="relative flex-1 text-white px-6 py-3 rounded-lg font-semibold transition-all hover:scale-105 active:scale-95">
                    <span class="btn-text"></span>
                  </button>
                </div>
              </div>

              <!-- Output Section -->
              <div class="translation-card rounded-xl shadow-lg p-6">
                <label id="output-label" class="block font-semibold mb-4"></label>
                
                <div class="flex flex-wrap gap-2 mb-4">
                  ${languages.map(lang => `
                    <button class="lang-btn output-lang px-4 py-2 rounded-lg transition-all hover:scale-105" 
                            data-lang="${lang.code}">
                      <span class="mr-1">${lang.flag}</span>
                      <span class="lang-label">${lang.name}</span>
                    </button>
                  `).join('')}
                </div>

                <textarea id="output-text" 
                          class="w-full h-40 p-4 rounded-lg border-2 resize-none focus:outline-none"
                          placeholder="Translation will appear here..."
                          readonly></textarea>

                <div class="flex gap-2 mt-4">
                  <button id="translate-btn" 
                          class="flex-1 text-white px-6 py-3 rounded-lg font-semibold transition-all hover:scale-105 active:scale-95">
                  </button>
                  <button id="listen-btn" 
                          class="text-white px-6 py-3 rounded-lg font-semibold transition-all hover:scale-105 active:scale-95">
                  </button>
                </div>
              </div>
            </div>

            <div id="status-message" class="mt-6 text-center font-medium opacity-0 transition-opacity"></div>
          </div>
        </div>
      `;

      setupEventListeners();
      applyConfig();
    }

    // ===== Apply Config =====
    function applyConfig() {
      const baseSize = config.font_size || 16;
      const fontStack = 'system-ui, -apple-system, sans-serif';

      const appEl = document.getElementById('app');
      appEl.style.backgroundColor = config.background_color;
      appEl.style.fontFamily = `${config.font_family}, ${fontStack}`;
      appEl.style.color = config.text_color;

      const title = document.getElementById('title');
      title.textContent = config.app_title;
      title.style.color = config.text_color;
      title.style.fontSize = `${baseSize * 2}px`;

      const subtitle = document.getElementById('subtitle');
      subtitle.textContent = config.subtitle;
      subtitle.style.color = config.text_color;
      subtitle.style.fontSize = `${baseSize}px`;

      const inputLabel = document.getElementById('input-label');
      inputLabel.textContent = config.input_label;
      inputLabel.style.color = config.text_color;
      inputLabel.style.fontSize = `${baseSize * 1.125}px`;

      const outputLabel = document.getElementById('output-label');
      outputLabel.textContent = config.output_label;
      outputLabel.style.color = config.text_color;
      outputLabel.style.fontSize = `${baseSize * 1.125}px`;

      document.querySelectorAll('.translation-card').forEach(c => {
        c.style.backgroundColor = config.surface_color;
      });

      document.querySelectorAll('textarea').forEach(t => {
        t.style.color = config.text_color;
        t.style.fontSize = `${baseSize}px`;
      });

      const speakBtn = document.getElementById('speak-btn');
      speakBtn.style.backgroundColor = config.secondary_action_color;
      speakBtn.querySelector('.btn-text').textContent = config.speak_button_text;
      speakBtn.style.fontSize = `${baseSize}px`;

      const translateBtn = document.getElementById('translate-btn');
      translateBtn.style.backgroundColor = config.primary_action_color;
      translateBtn.textContent = config.translate_button_text;
      translateBtn.style.fontSize = `${baseSize}px`;

      const listenBtn = document.getElementById('listen-btn');
      listenBtn.style.backgroundColor = config.primary_action_color;
      listenBtn.textContent = config.listen_button_text;
      listenBtn.style.fontSize = `${baseSize}px`;

      document.querySelectorAll('.lang-btn').forEach(b => {
        b.style.fontSize = `${baseSize * 0.875}px`;
      });
      document.querySelectorAll('.lang-label').forEach(l => {
        l.style.color = config.text_color;
        l.style.fontSize = `${baseSize * 0.875}px`;
      });

      // Load input text from localStorage
      const savedInput = localStorage.getItem('inputText');
      if (savedInput) document.getElementById('input-text').value = savedInput;
    }

    // ===== Status Message =====
    function showStatus(msg) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = msg;
      statusEl.style.opacity = '1';
      setTimeout(() => { statusEl.style.opacity = '0'; }, 3000);
    }

    // ===== Event Listeners =====
    function setupEventListeners() {
      let selectedInputLang = 'en-US';
      let selectedOutputLang = 'ms-MY';

      // Language selection
      document.querySelectorAll('.input-lang').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.input-lang').forEach(b => b.classList.remove('ring-4'));
          btn.classList.add('ring-4');
          selectedInputLang = btn.dataset.lang;
          showStatus(`Input language: ${btn.textContent.trim()}`);
        });
      });

      document.querySelectorAll('.output-lang').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.output-lang').forEach(b => b.classList.remove('ring-4'));
          btn.classList.add('ring-4');
          selectedOutputLang = btn.dataset.lang;
          showStatus(`Output language: ${btn.textContent.trim()}`);
        });
      });

      document.querySelector('.input-lang[data-lang="en-US"]').classList.add('ring-4');
      document.querySelector('.output-lang[data-lang="ms-MY"]').classList.add('ring-4');

      // Speech Recognition
      const speakBtn = document.getElementById('speak-btn');
      const inputText = document.getElementById('input-text');
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
          isListening = true;
          speakBtn.classList.add('recording-pulse');
          showStatus('ðŸŽ¤ Listening...');
        };

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          inputText.value = transcript;
        };

        recognition.onend = () => {
          isListening = false;
          speakBtn.classList.remove('recording-pulse');
          showStatus('âœ“ Recording complete');
          localStorage.setItem('inputText', inputText.value);
        };

        speakBtn.addEventListener('click', () => {
          if (isListening) recognition.stop();
          else { recognition.lang = selectedInputLang; inputText.value=''; recognition.start(); }
        });
      } else { speakBtn.disabled = true; showStatus('Speech recognition not supported'); }

      // Translation button
      const translateBtn = document.getElementById('translate-btn');
      const outputText = document.getElementById('output-text');
      translateBtn.addEventListener('click', async () => {
        const text = inputText.value.trim();
        if (!text) { showStatus('Please enter or speak some text'); return; }

        translateBtn.disabled = true;
        showStatus('ðŸ”„ Translating...');
        try {
          const langMap = { 'ms-MY':'ms', 'en-US':'en', 'zh-CN':'zh', 'ta-IN':'ta' };
          const src = langMap[selectedInputLang];
          const tgt = langMap[selectedOutputLang];
          if (src === tgt) { outputText.value = text; showStatus('âœ“ Same language'); translateBtn.disabled=false; return; }

          const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${src}&tl=${tgt}&dt=t&q=${encodeURIComponent(text)}`;
          const res = await fetch(url);
          const data = await res.json();
          let translated = '';
          for (let i=0;i<data[0].length;i++) { translated+=data[0][i][0]; }
          outputText.value = translated;
          showStatus('âœ“ Translation complete!');
        } catch (err) { outputText.value='Translation failed'; showStatus('âŒ Error'); }
        translateBtn.disabled = false;
      });

      // Listen button
      const listenBtn = document.getElementById('listen-btn');
      listenBtn.addEventListener('click', () => {
        const text = outputText.value.trim();
        if (!text) { showStatus('No translation to speak'); return; }

        synthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = selectedOutputLang;
        utterance.rate = 0.9;

        utterance.onstart = () => { listenBtn.classList.add('listening-indicator'); showStatus('ðŸ”Š Speaking...'); }
        utterance.onend = () => { listenBtn.classList.remove('listening-indicator'); showStatus('âœ“ Finished speaking'); }

        synthesis.speak(utterance);
      });

      // Save input text on typing
      inputText.addEventListener('input', () => {
        localStorage.setItem('inputText', inputText.value);
      });
    }

    // ===== Initialize =====
    createUI();
  </script>
</body>
</html>
